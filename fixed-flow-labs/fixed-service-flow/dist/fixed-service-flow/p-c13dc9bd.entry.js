import{r as e,a as r,h as t,H as i}from"./p-CYQeQM-n.js";import{p as n}from"./p-DkzKzVg0.js";import{c as a}from"./p-Cu1hlKnH.js";import{s as o}from"./p-BmMai6aX.js";import"./p-CNBAjIjF.js";const s=()=>`:host{display:block;width:100%;min-height:100%;background-color:#FAFAFA}.step-payment{width:100%;max-width:800px;margin:0 auto;padding:1.5rem;min-height:100vh}.header{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap}.header .btn-back-nav{display:flex;align-items:center;gap:0.25rem;background:none;border:none;color:#0097A9;font-size:0.875rem;cursor:pointer;padding:0.25rem}.header .btn-back-nav svg{width:20px;height:20px}.header .btn-back-nav:hover{text-decoration:underline}.header .title{font-size:1.75rem;font-weight:700;color:#1A1A1A;margin:0;flex:1}.content{background:white;border-radius:0.75rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);min-height:400px}.loading-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;text-align:center;padding:2rem}.loading-container h3{font-size:1.5rem;color:#1A1A1A;margin:1rem 0 0.5rem 0}.loading-container p{color:#666666;margin:0 0 0.5rem 0}.loading-container .warning{color:#DA291C;font-weight:500;font-size:0.875rem}.spinner{width:48px;height:48px;border:4px solid #E5E5E5;border-top-color:#DA291C;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.payment-container{display:flex;flex-direction:column;gap:1.5rem}.payment-summary{background:#FAFAFA;border-radius:0.5rem;padding:1rem}.payment-summary h3{font-size:1rem;font-weight:600;color:#1A1A1A;margin:0 0 1rem 0}.amount-display{display:flex;justify-content:space-between;align-items:center;padding:0.5rem 0;border-bottom:1px solid #E5E5E5}.amount-display .label{font-size:1rem;color:#666666}.amount-display .value{font-size:1.5rem;font-weight:700;color:#DA291C}.payment-items{margin-top:1rem}.payment-items .payment-item{display:flex;justify-content:space-between;align-items:center;padding:0.25rem 0;font-size:0.875rem}.payment-items .payment-item .item-type{color:#666666}.payment-items .payment-item .item-amount{color:#1A1A1A;font-weight:500}.iframe-container{border:1px solid #E5E5E5;border-radius:0.5rem;overflow:hidden;min-height:400px}.iframe-container iframe{display:block;border:none;width:100%}.iframe-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;background:#FAFAFA}.iframe-placeholder p{color:#666666;margin-top:1rem}.success-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;text-align:center;padding:2rem}.success-container .success-icon{width:80px;height:80px;background:rgb(209.6296296296, 237.3703703704, 219.2222222222);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:1rem}.success-container .success-icon svg{width:48px;height:48px;color:#44AF69}.success-container h3{font-size:1.5rem;color:#44AF69;margin:0 0 0.5rem 0}.success-container p{color:#666666;margin:0 0 0.5rem 0}.success-container .redirect-note{font-size:0.875rem;color:#808080}.error-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;text-align:center;padding:2rem}.error-container .error-icon{width:80px;height:80px;background:rgb(245.2682926829, 183.75, 179.2317073171);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:1rem}.error-container .error-icon svg{width:48px;height:48px;color:#DA291C}.error-container h3{font-size:1.5rem;color:#DA291C;margin:0 0 0.5rem 0}.error-container p{color:#666666;margin:0 0 1.5rem 0;max-width:400px}.error-actions{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center}.btn-retry{height:44px;padding:0 1.5rem;background:#DA291C;color:white;border:none;border-radius:9999px;font-size:1rem;font-weight:600;cursor:pointer;transition:background 0.2s}.btn-retry:hover{background:rgb(172.8048780488, 32.5, 22.1951219512)}.btn-back{height:44px;padding:0 1.5rem;background:white;color:#4D4D4D;border:1px solid #CCCCCC;border-radius:9999px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.2s}.btn-back:hover{background:#FAFAFA;border-color:#999999}.btn-cancel{align-self:center;height:44px;padding:0 1.5rem;background:white;color:#666666;border:1px solid #CCCCCC;border-radius:9999px;font-size:0.875rem;cursor:pointer;transition:all 0.2s}.btn-cancel:hover{background:#FAFAFA;border-color:#999999}`;const c=class{constructor(r){e(this,r)}get el(){return r(this)}onNext;onBack;paymentIframeUrl;screen="loading";error=null;cart=null;orderBan="";totalAmount=0;paymentItems=[];iframeUrl="";iframeHeight="500px";paymentResult=null;userName="";userLastName="";userEmail="";componentWillLoad(){this.loadCartAndPreparePayment()}componentDidLoad(){window.addEventListener("message",this.handleIframeMessage)}disconnectedCallback(){window.removeEventListener("message",this.handleIframeMessage)}async loadCartAndPreparePayment(){this.screen="loading";this.error=null;try{const e=await a.getCart();if(e.hasError){this.error=e.message||"Error al cargar el carrito";this.screen="error";return}if(!e.products||e.products.length===0){this.error="El carrito está vacío";this.screen="error";return}this.cart=e;this.paymentItems=n.buildPaymentItems({depositAmount:e.depositAmount,totalDownPayment:e.totalDownPayment,totalTax:e.totalTax,totalPrice:e.totalPrice,installmentAmount:e.installmentAmount,cartUpdateResponse:e.cartUpdateResponse});this.totalAmount=this.paymentItems.length>0?n.calculateTotalAmount(this.paymentItems):e.totalPrice||0;const r=o.getStoredShippingAddress();if(r){const e=r.name.split(" ");this.userName=e[0]||"";this.userLastName=e.slice(1).join(" ")||"";this.userEmail=r.email}await this.createOrder()}catch(e){console.error("[StepPayment] Error:",e);this.error="Error de conexión";this.screen="error"}}async createOrder(){this.screen="creating-order";try{const e=o.getZipCode();const r=await n.createOrder({flowId:"5",frontFlowId:"1",frontFlowName:"CLARO HOGAR Purchase",amount:this.totalAmount.toString(),email:this.userEmail,zipCode:e,deposit:(this.cart?.totalDownPayment||0).toString()});if(r.hasError){this.error=r.errorDisplay||r.message||"Error al crear la orden";this.screen="error";return}this.orderBan=r.ban||"";await this.initializePaymentIframe()}catch(e){console.error("[StepPayment] Create order error:",e);this.error="Error al crear la orden";this.screen="error"}}async initializePaymentIframe(){if(this.totalAmount<=0){await this.handleFreePayment();return}try{const e={firstName:this.userName,lastName:this.userLastName,email:this.userEmail,amount:this.totalAmount,transactionType:this.paymentItems.length>0?"MULTIPLE":"payment",selectBan:this.orderBan,permissions:{provision:true,displayConfirmation:true,emailNotification:true,showInstrument:true,stroeInstrument:true,useBanZipCode:true},paymentItems:this.paymentItems.length>0?this.paymentItems:undefined};const r=await n.getPaymentIframe(e);if(r.errorInfo?.hasError||!r.url){this.error=r.errorInfo?.errorDisplay||"Error al inicializar el pago";this.screen="error";return}this.iframeUrl=r.url;this.screen="payment"}catch(e){console.error("[StepPayment] Init iframe error:",e);this.error="Error al inicializar el formulario de pago";this.screen="error"}}handleIframeMessage=e=>{if(typeof e.data!=="string")return;try{const r=JSON.parse(atob(e.data));if(r.state==="dimensions"){this.iframeHeight=r.data.height}if(r.state==="canceled"){this.handlePaymentCancel()}if(r.state==="paymentResult"){if(r.data){const e=r.data;const t=JSON.parse(e).paymentResult;const i=JSON.parse(atob(t));if(i.success){this.handlePaymentSuccess(i)}else{this.handlePaymentError(i)}}}}catch{}};async handlePaymentSuccess(e){this.screen="processing";this.paymentResult=e;try{const r=await n.recordPayment({ban:this.orderBan,cardNumber:e.paymentCard||"",cardType:e.paymentMethod||"",authorizationNumber:e.authorizationNumber||"",referenceNumber:e.provisioning?.referenceNumber||"",description:e.description||"",operationId:e.operationId||"",amount:this.totalAmount.toString(),deposit:(this.cart?.totalDownPayment||0).toString()});if(r.hasError){this.error=r.errorDisplay||"Error al registrar el pago";this.screen="error";return}n.storePaymentResult(e);this.screen="success";setTimeout((()=>{this.onNext?.()}),2e3)}catch(e){console.error("[StepPayment] Record payment error:",e);this.error="Error al registrar el pago";this.screen="error"}}async handlePaymentError(e){await n.recordPaymentError(this.orderBan,"",e.description||"Payment failed",e.operationId||"",(this.cart?.totalDownPayment||0).toString(),e.paymentMethod||"",e.paymentCard||"",this.totalAmount.toString());this.error=e.description||"El pago no pudo ser procesado";this.screen="error"}handlePaymentCancel(){this.onBack?.()}async handleFreePayment(){this.screen="processing";try{const e=Math.floor(Math.random()*9e5+1e5).toString();const r=await n.recordPayment({ban:this.orderBan,cardNumber:"1111",cardType:"V",authorizationNumber:"FREEPR",referenceNumber:"FREEPROMO",description:"Free promotion",operationId:e,amount:"0",deposit:"0"});if(r.hasError){this.error=r.errorDisplay||"Error al procesar";this.screen="error";return}this.screen="success";setTimeout((()=>{this.onNext?.()}),2e3)}catch(e){console.error("[StepPayment] Free payment error:",e);this.error="Error al procesar";this.screen="error"}}handleRetry=()=>{this.loadCartAndPreparePayment()};formatPrice(e){return`$${(e||0).toFixed(2)}`}renderLoading(){return t("div",{class:"loading-container"},t("div",{class:"spinner"}),t("p",null,"Cargando información del pago..."))}renderCreatingOrder(){return t("div",{class:"loading-container"},t("div",{class:"spinner"}),t("h3",null,"Preparando tu orden"),t("p",null,"Por favor espera mientras procesamos tu solicitud..."),t("p",{class:"warning"},"No cierres esta ventana ni navegues a otra página."))}renderPaymentForm(){return t("div",{class:"payment-container"},t("div",{class:"payment-summary"},t("h3",null,"Resumen del pago"),t("div",{class:"amount-display"},t("span",{class:"label"},"Total a pagar:"),t("span",{class:"value"},this.formatPrice(this.totalAmount))),this.paymentItems.length>0&&t("div",{class:"payment-items"},this.paymentItems.map((e=>t("div",{class:"payment-item"},t("span",{class:"item-type"},this.getPaymentTypeLabel(e.paymentType)),t("span",{class:"item-amount"},this.formatPrice(e.amount))))))),t("div",{class:"iframe-container"},this.iframeUrl?t("iframe",{src:this.iframeUrl,width:"100%",height:this.iframeHeight,frameBorder:"0",title:"Payment Form"}):t("div",{class:"iframe-placeholder"},t("div",{class:"spinner"}),t("p",null,"Cargando formulario de pago..."))),t("button",{class:"btn-cancel",onClick:()=>this.handlePaymentCancel()},"Cancelar"))}renderProcessing(){return t("div",{class:"loading-container"},t("div",{class:"spinner"}),t("h3",null,"Procesando pago"),t("p",null,"Por favor espera mientras confirmamos tu pago..."))}renderSuccess(){return t("div",{class:"success-container"},t("div",{class:"success-icon"},t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},t("path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14"}),t("polyline",{points:"22 4 12 14.01 9 11.01"}))),t("h3",null,"Pago exitoso"),t("p",null,"Tu pago ha sido procesado correctamente."),t("p",{class:"redirect-note"},"Redirigiendo a la confirmación..."))}renderError(){return t("div",{class:"error-container"},t("div",{class:"error-icon"},t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},t("circle",{cx:"12",cy:"12",r:"10"}),t("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),t("line",{x1:"9",y1:"9",x2:"15",y2:"15"}))),t("h3",null,"Error en el pago"),t("p",null,this.error),t("div",{class:"error-actions"},t("button",{class:"btn-retry",onClick:this.handleRetry},"Intentar nuevamente"),t("button",{class:"btn-back",onClick:()=>this.onBack?.()},"Volver")))}getPaymentTypeLabel(e){const r={DEPOSIT:"Depósito",DOWNPAYMENT:"Pago inicial",TAXES:"Impuestos",INSTALLMENT:"Cuotas",PASTDUEONLY:"Balance pendiente"};return r[e]||e}render(){return t(i,{key:"21fbece589666712eebf1c6ce301d2f06e93632a"},t("div",{key:"40b21d6f072b7c6114cdc40ccd062c9e64219f21",class:"step-payment"},t("div",{key:"a820b9ae6b8e56cd94c71be976b95f7ea3af5428",class:"header"},this.screen!=="processing"&&this.screen!=="success"&&t("button",{key:"7dfc9a52346488553e88e191ddcd1bd04a406c9c",class:"btn-back-nav",onClick:()=>this.onBack?.()},t("svg",{key:"3ed1b06f438a1714cbc4448093861d3966e83bca",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},t("path",{key:"f9a83b2a85f15c439e8e4d2f2a3792afb9919538",d:"M19 12H5M12 19l-7-7 7-7"})),"Regresar"),t("h1",{key:"ac4e4feecd04bc7d5636ab1002f1c83d9ec38c3b",class:"title"},"Pago")),t("div",{key:"369e171e812267ea50349dd08389cb1ee14b313b",class:"content"},this.screen==="loading"&&this.renderLoading(),this.screen==="creating-order"&&this.renderCreatingOrder(),this.screen==="payment"&&this.renderPaymentForm(),this.screen==="processing"&&this.renderProcessing(),this.screen==="success"&&this.renderSuccess(),this.screen==="error"&&this.renderError())))}};c.style=s();export{c as step_payment};
//# sourceMappingURL=p-c13dc9bd.entry.js.map