{"version":3,"file":"p-DkzKzVg0.js","sources":["src/services/payment.service.ts"],"sourcesContent":["// ============================================\n// PAYMENT SERVICE - Payment Processing\n// Fixed Service Flow Web Component\n// Based on TEL PaymentService & PaymentIframeService\n// ============================================\n\nimport { httpService } from './http.service';\nimport { tokenService } from './token.service';\nimport { storageUtils } from '../utils/storage.utils';\n\n// ------------------------------------------\n// INTERFACES\n// ------------------------------------------\n\nexport interface PaymentItem {\n  paymentType: 'DEPOSIT' | 'DOWNPAYMENT' | 'TAXES' | 'INSTALLMENT' | 'PASTDUEONLY';\n  amount: number;\n}\n\nexport interface OrderCreationRequest {\n  flowId: string;\n  frontFlowId: string;\n  frontFlowName: string;\n  banExisting?: string;\n  subscriberExisting?: string;\n  amount: string;\n  email: string;\n  zipCode: string;\n  deposit: string;\n  pastDueAmount?: string;\n}\n\nexport interface OrderCreationResponse {\n  hasError: boolean;\n  ban?: string;\n  errorDisplay?: string;\n  message?: string;\n}\n\nexport interface PaymentRecordRequest {\n  ban: string;\n  cardNumber: string;\n  cardType: string;\n  authorizationNumber: string;\n  referenceNumber: string;\n  description: string;\n  operationId: string;\n  amount: string;\n  deposit: string;\n}\n\nexport interface PaymentRecordResponse {\n  hasError: boolean;\n  ban?: string;\n  errorDisplay?: string;\n  message?: string;\n}\n\nexport interface PaymentIframeRequest {\n  ssoToken?: string;\n  firstName: string;\n  lastName: string;\n  email: string;\n  amount: number;\n  transactionType: string;\n  selectBan: string;\n  currentSubscriber?: string;\n  permissions: {\n    provision: boolean;\n    displayConfirmation: boolean;\n    emailNotification: boolean;\n    showInstrument: boolean;\n    stroeInstrument: boolean;\n    useBanZipCode: boolean;\n  };\n  paymentItems?: PaymentItem[];\n  installments?: {\n    locationId: string;\n    invoiceNumber: string;\n    installmentCount: number;\n  };\n}\n\nexport interface PaymentIframeResponse {\n  errorInfo: {\n    hasError: boolean;\n    errorDisplay?: string;\n  };\n  url?: string;\n}\n\nexport interface PaymentResult {\n  success: boolean;\n  authorizationNumber?: string;\n  code?: string;\n  date?: string;\n  description?: string;\n  operationId?: string;\n  operationType?: string;\n  paymentMethod?: string;\n  paymentCard?: string;\n  provisioning?: {\n    referenceNumber: string;\n  };\n  storedInstrument?: any;\n}\n\n// ------------------------------------------\n// STORAGE KEYS\n// ------------------------------------------\n\nconst STORAGE_KEYS = {\n  ORDER_BAN: 'orderBan',\n  PAYMENT_RESULT: 'paymentResult',\n};\n\n// ------------------------------------------\n// PAYMENT SERVICE CLASS\n// ------------------------------------------\n\nexport class PaymentService {\n  private paymentIframeUrl: string = '';\n\n  /**\n   * Set the payment iframe URL (from environment config)\n   */\n  setPaymentIframeUrl(url: string): void {\n    this.paymentIframeUrl = url;\n  }\n\n  /**\n   * Get the payment iframe URL\n   */\n  getPaymentIframeUrl(): string {\n    return this.paymentIframeUrl;\n  }\n\n  // ------------------------------------------\n  // API METHODS\n  // ------------------------------------------\n\n  /**\n   * Create order before payment\n   */\n  async createOrder(request: OrderCreationRequest): Promise<OrderCreationResponse> {\n    const token = tokenService.getToken();\n\n    const formData = new FormData();\n    formData.append('token', token);\n    formData.append('flowId', request.flowId);\n    formData.append('frontFlowId', request.frontFlowId);\n    formData.append('frontFlowName', request.frontFlowName);\n    formData.append('banExisting', request.banExisting || '');\n    formData.append('subscriberExisting', request.subscriberExisting || '');\n    formData.append('amount', request.amount);\n    formData.append('email', request.email);\n    formData.append('zipCode', request.zipCode);\n    formData.append('deposit', request.deposit);\n    formData.append('pastDueAmount', request.pastDueAmount || '0');\n\n    try {\n      const response = await httpService.postFormData<OrderCreationResponse>(\n        'api/Orders/creationOfOrder',\n        formData\n      );\n\n      if (!response.hasError && response.ban) {\n        this.storeOrderBan(response.ban);\n      }\n\n      return response;\n    } catch (error) {\n      console.error('[PaymentService] Create order error:', error);\n      return {\n        hasError: true,\n        errorDisplay: 'Error al crear la orden',\n      };\n    }\n  }\n\n  /**\n   * Record successful payment\n   */\n  async recordPayment(request: PaymentRecordRequest): Promise<PaymentRecordResponse> {\n    const token = tokenService.getToken();\n\n    const formData = new FormData();\n    formData.append('token', token);\n    formData.append('ban', request.ban);\n    formData.append('cardNumber', request.cardNumber);\n    formData.append('cardType', request.cardType);\n    formData.append('authorizationNumber', request.authorizationNumber);\n    formData.append('referenceNumber', request.referenceNumber);\n    formData.append('description', request.description);\n    formData.append('operationId', request.operationId);\n    formData.append('amount', request.amount);\n    formData.append('deposit', request.deposit);\n\n    try {\n      const response = await httpService.postFormData<PaymentRecordResponse>(\n        'api/Payment/record',\n        formData\n      );\n      return response;\n    } catch (error) {\n      console.error('[PaymentService] Record payment error:', error);\n      return {\n        hasError: true,\n        errorDisplay: 'Error al registrar el pago',\n      };\n    }\n  }\n\n  /**\n   * Record payment error\n   */\n  async recordPaymentError(\n    ban: string,\n    subscriber: string,\n    description: string,\n    operationId: string,\n    deposit: string,\n    cardType: string,\n    cardNumber: string,\n    amount: string\n  ): Promise<any> {\n    const token = tokenService.getToken();\n\n    const formData = new FormData();\n    formData.append('token', token);\n    formData.append('ban', ban);\n    formData.append('subscriber', subscriber);\n    formData.append('description', description);\n    formData.append('operationId', operationId);\n    formData.append('deposit', deposit);\n    formData.append('cardType', cardType);\n    formData.append('cardNumber', cardNumber);\n    formData.append('amount', amount);\n\n    try {\n      return await httpService.postFormData<any>('api/Payment/error', formData);\n    } catch (error) {\n      console.error('[PaymentService] Record error error:', error);\n      return { hasError: true };\n    }\n  }\n\n  /**\n   * Get payment iframe URL\n   * TEL uses: api/Payment/getPaymentIframe (NOT getIframe)\n   */\n  async getPaymentIframe(request: PaymentIframeRequest): Promise<PaymentIframeResponse> {\n    try {\n      const response = await httpService.post<PaymentIframeResponse>(\n        'api/Payment/getPaymentIframe',\n        request\n      );\n      return response;\n    } catch (error) {\n      console.error('[PaymentService] Get iframe error:', error);\n      return {\n        errorInfo: {\n          hasError: true,\n          errorDisplay: 'Error al obtener el iframe de pago',\n        },\n      };\n    }\n  }\n\n  // ------------------------------------------\n  // STORAGE METHODS\n  // ------------------------------------------\n\n  storeOrderBan(ban: string): void {\n    storageUtils.set(STORAGE_KEYS.ORDER_BAN, ban);\n  }\n\n  getOrderBan(): string {\n    return storageUtils.get(STORAGE_KEYS.ORDER_BAN) || '';\n  }\n\n  storePaymentResult(result: PaymentResult): void {\n    storageUtils.setJSON(STORAGE_KEYS.PAYMENT_RESULT, result);\n  }\n\n  getPaymentResult(): PaymentResult | null {\n    return storageUtils.getJSON<PaymentResult>(STORAGE_KEYS.PAYMENT_RESULT);\n  }\n\n  clearPaymentData(): void {\n    storageUtils.remove(STORAGE_KEYS.ORDER_BAN);\n    storageUtils.remove(STORAGE_KEYS.PAYMENT_RESULT);\n  }\n\n  // ------------------------------------------\n  // PAYMENT ITEMS HELPERS\n  // ------------------------------------------\n\n  /**\n   * Build payment items array from cart data\n   */\n  buildPaymentItems(cartData: {\n    depositAmount?: number;\n    totalDownPayment?: number;\n    totalTax?: number;\n    totalPrice?: number;\n    installmentAmount?: number;\n    cartUpdateResponse?: {\n      acceletartedAmount?: number;\n    };\n  }): PaymentItem[] {\n    const items: PaymentItem[] = [];\n\n    if (cartData.depositAmount && cartData.depositAmount > 0) {\n      items.push({ paymentType: 'DEPOSIT', amount: cartData.depositAmount });\n    }\n\n    if (cartData.totalDownPayment && cartData.totalDownPayment > 0) {\n      items.push({ paymentType: 'DOWNPAYMENT', amount: cartData.totalDownPayment });\n    }\n\n    if (cartData.totalTax && cartData.totalTax > 0) {\n      // Calculate tax portion\n      const taxAmount =\n        (cartData.totalPrice || 0) -\n        (cartData.depositAmount || 0) -\n        (cartData.totalDownPayment || 0) -\n        (cartData.installmentAmount || 0);\n      if (taxAmount > 0) {\n        items.push({ paymentType: 'TAXES', amount: Number(taxAmount.toFixed(2)) });\n      }\n    }\n\n    if (cartData.cartUpdateResponse?.acceletartedAmount) {\n      items.push({\n        paymentType: 'INSTALLMENT',\n        amount: cartData.cartUpdateResponse.acceletartedAmount,\n      });\n    }\n\n    return items;\n  }\n\n  /**\n   * Calculate total amount from payment items\n   */\n  calculateTotalAmount(items: PaymentItem[]): number {\n    return items.reduce((sum, item) => sum + item.amount, 0);\n  }\n}\n\n// Export singleton instance\nexport const paymentService = new PaymentService();\n"],"names":[],"mappings":"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"}