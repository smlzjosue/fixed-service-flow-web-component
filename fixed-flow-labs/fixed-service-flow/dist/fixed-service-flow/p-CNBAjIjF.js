import{d as t,f as e}from"./p-CYQeQM-n.js";const n=(t,e,n)=>{const o=t.get(e);if(!o){t.set(e,[n])}else if(!o.includes(n)){o.push(n)}};const o=(t,e)=>{let n;return(...o)=>{if(n){clearTimeout(n)}n=setTimeout((()=>{n=0;t(...o)}),e)}};const s=t=>!("isConnected"in t)||t.isConnected;const r=o((t=>{for(let e of t.keys()){t.set(e,t.get(e).filter(s))}}),2e3);const a=()=>{if(typeof t!=="function"){return{}}const o=new Map;return{dispose:()=>o.clear(),get:e=>{const s=t();if(s){n(o,e,s)}},set:t=>{const n=o.get(t);if(n){o.set(t,n.filter(e))}r(o)},reset:()=>{o.forEach((t=>t.forEach(e)));r(o)}}};const i=t=>typeof t==="function"?t():t;const c=(t,e=(t,e)=>t!==e)=>{const n=i(t);let o=new Map(Object.entries(n??{}));const s={dispose:[],get:[],set:[],reset:[]};const r=new Map;const a=()=>{o=new Map(Object.entries(i(t)??{}));s.reset.forEach((t=>t()))};const c=()=>{s.dispose.forEach((t=>t()));a()};const u=t=>{s.get.forEach((e=>e(t)));return o.get(t)};const d=(t,n)=>{const r=o.get(t);if(e(n,r,t)){o.set(t,n);s.set.forEach((e=>e(t,n,r)))}};const f=typeof Proxy==="undefined"?{}:new Proxy(n,{get(t,e){return u(e)},ownKeys(t){return Array.from(o.keys())},getOwnPropertyDescriptor(){return{enumerable:true,configurable:true}},has(t,e){return o.has(e)},set(t,e,n){d(e,n);return true}});const h=(t,e)=>{s[t].push(e);return()=>{l(s[t],e)}};const g=(e,n)=>{const o=(t,o)=>{if(t===e){n(o)}};const s=()=>n(i(t)[e]);const a=h("set",o);const c=h("reset",s);r.set(n,{setHandler:o,resetHandler:s,propName:e});return()=>{a();c();r.delete(n)}};const p=(...t)=>{const e=t.reduce(((t,e)=>{if(e.set){t.push(h("set",e.set))}if(e.get){t.push(h("get",e.get))}if(e.reset){t.push(h("reset",e.reset))}if(e.dispose){t.push(h("dispose",e.dispose))}return t}),[]);return()=>e.forEach((t=>t()))};const S=t=>{const e=o.get(t);s.set.forEach((n=>n(t,e,e)))};const w=(t,e)=>{const n=r.get(e);if(n&&n.propName===t){l(s.set,n.setHandler);l(s.reset,n.resetHandler);r.delete(e)}};return{state:f,get:u,set:d,on:h,onChange:g,use:p,dispose:c,reset:a,forceUpdate:S,removeListener:w}};const l=(t,e)=>{const n=t.indexOf(e);if(n>=0){t[n]=t[t.length-1];t.length--}};const u=(t,e)=>{const n=c(t,e);n.use(a());return n};const d={currentStep:1,token:null,correlationId:null,location:null,availablePlans:[],selectedPlan:null,selectedContract:null,formData:null,orderId:null,requestError:null,isLoading:false,error:null};const{state:f,onChange:h,reset:g}=u(d);const p={setToken:(t,e)=>{f.token=t;f.correlationId=e;sessionStorage.setItem("token",t);sessionStorage.setItem("correlationId",e)},getStoredToken:()=>({token:sessionStorage.getItem("token"),correlationId:sessionStorage.getItem("correlationId")}),hasToken:()=>!!f.token||!!sessionStorage.getItem("token"),clearToken:()=>{f.token=null;f.correlationId=null;sessionStorage.removeItem("token");sessionStorage.removeItem("correlationId")},setStep:t=>{f.currentStep=t},nextStep:()=>{if(f.currentStep<5){f.currentStep=f.currentStep+1}},prevStep:()=>{if(f.currentStep>1){f.currentStep=f.currentStep-1}},setLocation:t=>{f.location=t;sessionStorage.setItem("latitud",btoa(String(t.latitude)));sessionStorage.setItem("longitud",btoa(String(t.longitude)));sessionStorage.setItem("planCodeInternet",btoa(t.serviceType))},setAvailablePlans:t=>{f.availablePlans=t},selectPlan:t=>{f.selectedPlan=t;sessionStorage.setItem("planId",String(t.planId));sessionStorage.setItem("planPrice",String(t.decPrice));sessionStorage.setItem("plan",JSON.stringify(t))},setContract:t=>{f.selectedContract=t;sessionStorage.setItem("typeContractId",String(t.typeId));sessionStorage.setItem("contractInstallment",String(t.deadlines));sessionStorage.setItem("contractInstallation",String(t.installation));sessionStorage.setItem("contractActivation",String(t.activation));sessionStorage.setItem("contractModen",String(t.modem))},setFormData:t=>{f.formData=t},setOrderResult:(t,e)=>{f.orderId=t;f.requestError=e},setLoading:t=>{f.isLoading=t},setError:t=>{f.error=t},clearError:()=>{f.error=null},resetFlow:()=>{const t=["planCodeInternet","latitud","longitud","planId","planPrice","plan","typeContractId","contractInstallment","contractInstallation","contractActivation","contractModen"];t.forEach((t=>sessionStorage.removeItem(t)));g()},getSubmissionData:()=>({location:f.location,plan:f.selectedPlan,contract:f.selectedContract,formData:f.formData})};if(typeof window!=="undefined"&&window.__FSF_DEBUG__){h("currentStep",(t=>{console.log("[FSF Store] Step changed:",t)}));h("isLoading",(t=>{console.log("[FSF Store] Loading:",t)}));h("error",(t=>{if(t){console.error("[FSF Store] Error:",t)}}))}class S extends Error{status;response;constructor(t,e,n){super(t);this.status=e;this.response=n;this.name="HttpError"}}class w{baseUrl="";defaultTimeout=6e4;setBaseUrl(t){this.baseUrl=t.replace(/\/$/,"")}getBaseUrl(){return this.baseUrl}setTimeout(t){this.defaultTimeout=t}getHeaders(t,e){const n=new Headers;if(!e){n.set("Content-Type","application/json")}const o=f.token||sessionStorage.getItem("token");const s=f.correlationId||sessionStorage.getItem("correlationId");if(o){n.set("Authorization",`Bearer ${o}`)}if(s){n.set("X-Correlation-ID",s)}n.set("App","shop");n.set("Platform","web");if(t){Object.entries(t).forEach((([t,e])=>{n.set(t,e)}))}return n}async request(t){const{method:e,endpoint:n,body:o,headers:s,timeout:r,isFormData:a}=t;const i=n.startsWith("/")?n:`/${n}`;const c=`${this.baseUrl}${i}`;const l=new AbortController;const u=setTimeout((()=>l.abort()),r||this.defaultTimeout);try{const t={method:e,headers:this.getHeaders(s,a),signal:l.signal};if(o&&e!=="GET"){if(a&&o instanceof FormData){t.body=o}else{t.body=JSON.stringify(o)}}const n=await fetch(c,t);clearTimeout(u);let r;const i=n.headers.get("content-type");const d=await n.text();if(d&&(d.startsWith("{")||d.startsWith("["))){try{r=JSON.parse(d)}catch{r=d}}else if(i&&i.includes("application/json")){try{r=JSON.parse(d)}catch{r=d}}else{r=d}if(!n.ok){throw new S(`HTTP Error: ${n.status} ${n.statusText}`,n.status,r)}return{data:r,status:n.status,ok:n.ok}}catch(t){clearTimeout(u);if(t instanceof S){throw t}if(t.name==="AbortError"){throw new S("Request timeout",408)}throw new S(t.message||"Network error",0)}}async get(t,e){const n=await this.request({method:"GET",endpoint:t,headers:e});return n.data}async post(t,e,n){const o=await this.request({method:"POST",endpoint:t,body:e,headers:n});return o.data}async postFormData(t,e,n){const o=await this.request({method:"POST",endpoint:t,body:e,headers:n,isFormData:true});return o.data}async put(t,e,n){const o=await this.request({method:"PUT",endpoint:t,body:e,headers:n});return o.data}async delete(t,e){const n=await this.request({method:"DELETE",endpoint:t,headers:e});return n.data}}const m=new w;class T{isInitializing=false;initPromise=null;async fetchToken(){const t=await m.post("api/Token/getToken",{agentName:""});if(t.hasError){throw new Error(t.message||"Failed to obtain token")}return t}async initialize(){if(this.isInitializing&&this.initPromise){return this.initPromise}this.isInitializing=true;this.initPromise=(async()=>{try{const t=p.getStoredToken();if(t.token&&t.correlationId){p.setToken(t.token,t.correlationId);console.log("[TokenService] Using existing token from sessionStorage");return true}console.log("[TokenService] Fetching new token...");const e=await this.fetchToken();p.setToken(e.token,e.correlationId);console.log("[TokenService] Token obtained and stored successfully");return true}catch(t){console.error("[TokenService] Failed to initialize token:",t);p.setError("Error al obtener el token de autenticaci√≥n");return false}finally{this.isInitializing=false}})();return this.initPromise}hasToken(){return p.hasToken()}getToken(){const t=p.getStoredToken();return t.token}getCorrelationId(){const t=p.getStoredToken();return t.correlationId}clearToken(){p.clearToken();console.log("[TokenService] Token cleared")}async refreshToken(){this.clearToken();return this.initialize()}async ensureToken(){if(!this.hasToken()){const t=await this.initialize();if(!t){throw new Error("Failed to obtain authentication token")}}}}const k=new T;export{p as f,m as h,f as s,k as t};
//# sourceMappingURL=p-CNBAjIjF.js.map