{"version":3,"file":"plans.service.js","sourceRoot":"","sources":["../../src/services/plans.service.ts"],"names":[],"mappings":"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","sourcesContent":["// ============================================\n// PLANS SERVICE - Internet Plans Management\n// Fixed Service Flow Web Component\n// ============================================\n\nimport { httpService } from './http.service';\nimport { tokenService } from './token.service';\nimport { PlansResponse, Plan, ApiResponse } from '../store/interfaces';\n\n// ------------------------------------------\n// INTERFACES\n// ------------------------------------------\n\ninterface AddToCartResponse extends ApiResponse {\n  code?: number; // cartId returned from backend\n}\n\ninterface CartItem {\n  token: string;\n  productId: number;\n  notificationDetailID: number;\n  chvSource: string;\n  promoCode: string;\n  installments: number;\n  decPrice: number;\n  decDeposit: number;\n  decDownPayment: number;\n  decTotalPrice: number;\n  Qty: number;\n  flowId: number;\n  ssoToken: string;\n  userID: string;\n  parentProductId: number;\n  parentCartId: number;\n  creditClass: string;\n  downgradeAllowed: boolean;\n  pendingAccelerated: number;\n  acceletartedAmount: number;\n  pastDueAmount: number;\n  delicuency: boolean;\n}\n\n// ------------------------------------------\n// PLANS SERVICE CLASS\n// ------------------------------------------\n\nclass PlansService {\n  // Track current plan in cart\n  private currentCartId: number = 0;\n\n  // ------------------------------------------\n  // GET PLANS\n  // ------------------------------------------\n\n  /**\n   * Fetches available internet plans for a service type\n   * Endpoint: POST api/Plans/getPlansInternet\n   *\n   * For CLARO HOGAR, the type should be \"internet\" (following TEL pattern)\n   */\n  async getPlans(serviceType: string, catalogId: number = 0): Promise<Plan[]> {\n    // Ensure token exists before making the call\n    await tokenService.ensureToken();\n\n    // Map service type to API type parameter\n    // TEL uses 'internet' for CLARO HOGAR products\n    let apiType = serviceType;\n    if (serviceType === 'CLARO HOGAR') {\n      apiType = 'internet';\n    }\n\n    console.log('[PlansService] Fetching plans for type:', apiType, 'catalogId:', catalogId);\n\n    const response = await httpService.post<PlansResponse>('api/Plans/getPlansInternet', {\n      catalogID: catalogId,\n      type: apiType,\n    });\n\n    console.log('[PlansService] Response:', response);\n\n    if (response.hasError) {\n      console.error('[PlansService] API error:', response.message);\n      throw new Error(response.message || 'Failed to fetch plans');\n    }\n\n    console.log('[PlansService] Plans found:', response.planList?.length || 0);\n    return response.planList || [];\n  }\n\n  // ------------------------------------------\n  // ADD TO CART (Main method - like TEL's api/Card/addToCart)\n  // ------------------------------------------\n\n  /**\n   * Adds a plan to the cart\n   * This replicates TEL's Card.pushAddToCart + Card.addToCart flow\n   * Endpoint: POST api/Card/addToCart\n   */\n  async addToCart(\n    plan: Plan,\n    parentCartId: number = 0,\n    parentProductId: number = 0,\n    installments: number = 0,\n    creditClass: string = ''\n  ): Promise<AddToCartResponse> {\n    // Ensure token exists before making the call\n    await tokenService.ensureToken();\n\n    const token = tokenService.getToken() || '';\n    const price = this.getEffectivePrice(plan);\n\n    // Build cart item following TEL's pushAddToCart structure\n    const cartItem: CartItem = {\n      token: token,\n      productId: plan.planId,\n      notificationDetailID: 0,\n      chvSource: '',\n      promoCode: sessionStorage.getItem('discountCoupon') || '',\n      installments: installments,\n      decPrice: price,\n      decDeposit: 0,\n      decDownPayment: 0,\n      decTotalPrice: price,\n      Qty: 1,\n      flowId: 1,\n      ssoToken: '',\n      userID: '0',\n      parentProductId: parentProductId,\n      parentCartId: parentCartId,\n      creditClass: creditClass,\n      downgradeAllowed: false,\n      pendingAccelerated: 0,\n      acceletartedAmount: 0,\n      pastDueAmount: 0,\n      delicuency: false,\n    };\n\n    // POST to api/Card/addToCart with cartItems as JSON string array\n    const response = await httpService.post<AddToCartResponse>('api/Card/addToCart', {\n      cartItems: JSON.stringify([cartItem]),\n    });\n\n    if (response.hasError) {\n      throw new Error(response.message || 'Failed to add plan to cart');\n    }\n\n    // Store cart info for later operations\n    if (response.code) {\n      this.currentCartId = response.code;\n    }\n\n    // Also store in sessionStorage (TEL pattern)\n    this.storePlanInSession(plan);\n\n    return response;\n  }\n\n  // ------------------------------------------\n  // ADD TO CART CURRENT PLAN (Keep existing plan)\n  // ------------------------------------------\n\n  /**\n   * Keeps the current plan in cart (used when continuing with existing plan)\n   * Endpoint: POST api/Plans/addToCartCurrentPlan\n   */\n  async addToCartCurrentPlan(productId: number, cartId: number): Promise<ApiResponse> {\n    // Ensure token exists before making the call\n    await tokenService.ensureToken();\n\n    const formData = new FormData();\n    formData.append('productId', String(productId));\n    formData.append('cartId', String(cartId));\n\n    return await httpService.postFormData<ApiResponse>('api/Plans/addToCartCurrentPlan', formData);\n  }\n\n  // ------------------------------------------\n  // DELETE PLAN FROM CART\n  // ------------------------------------------\n\n  /**\n   * Removes a plan from the cart\n   * Endpoint: POST api/Card/deleteItem\n   */\n  async deleteFromCart(cartId: number, productId: number = 0): Promise<ApiResponse> {\n    await tokenService.ensureToken();\n\n    const response = await httpService.post<ApiResponse>('api/Card/deleteItem', {\n      cartId: cartId,\n      productId: productId,\n    });\n\n    if (!response.hasError) {\n      // Clear local tracking if we deleted the current plan\n      if (cartId === this.currentCartId) {\n        this.currentCartId = 0;\n      }\n    }\n\n    return response;\n  }\n\n  // ------------------------------------------\n  // SESSION STORAGE (TEL Pattern)\n  // ------------------------------------------\n\n  /**\n   * Stores plan data in sessionStorage following TEL's pattern\n   */\n  private storePlanInSession(plan: Plan): void {\n    try {\n      // Store full plan object\n      sessionStorage.setItem('plan', JSON.stringify(plan));\n      // Store plan ID\n      sessionStorage.setItem('planId', String(plan.planId));\n      // Store price\n      const price = this.getEffectivePrice(plan);\n      sessionStorage.setItem('planPrice', String(price));\n      // Store plan code in Base64 (TEL pattern)\n      sessionStorage.setItem('planCodeInternet', btoa(plan.planSoc || String(plan.planId)));\n    } catch (e) {\n      console.error('[PlansService] Error storing plan in session:', e);\n    }\n  }\n\n  /**\n   * Gets stored plan from sessionStorage\n   */\n  getStoredPlan(): Plan | null {\n    try {\n      const planData = sessionStorage.getItem('plan');\n      return planData ? JSON.parse(planData) : null;\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Gets stored plan ID from sessionStorage\n   */\n  getStoredPlanId(): number {\n    const planId = sessionStorage.getItem('planId');\n    return planId ? parseInt(planId, 10) : 0;\n  }\n\n  /**\n   * Gets current cart ID\n   */\n  getCartId(): number {\n    return this.currentCartId;\n  }\n\n  /**\n   * Sets current cart ID (from parent flow)\n   */\n  setCartId(cartId: number): void {\n    this.currentCartId = cartId;\n  }\n\n  /**\n   * Clears plan from session and memory\n   */\n  clearPlan(): void {\n    this.currentCartId = 0;\n    sessionStorage.removeItem('plan');\n    sessionStorage.removeItem('planId');\n    sessionStorage.removeItem('planPrice');\n    sessionStorage.removeItem('planCodeInternet');\n  }\n\n  // ------------------------------------------\n  // HELPER METHODS\n  // ------------------------------------------\n\n  /**\n   * Formats price for display\n   */\n  formatPrice(price: number): string {\n    return `$${price.toFixed(2)}`;\n  }\n\n  /**\n   * Parses plan description HTML to extract features\n   */\n  parsePlanFeatures(description: string): string[] {\n    if (!description) return [];\n\n    // Extract text from <li> tags\n    const liRegex = /<li[^>]*>([^<]+)<\\/li>/gi;\n    const features: string[] = [];\n    let match;\n\n    while ((match = liRegex.exec(description)) !== null) {\n      features.push(match[1].trim());\n    }\n\n    return features;\n  }\n\n  /**\n   * Gets the discount percentage if there's a sale price\n   */\n  getDiscountPercentage(originalPrice: number, salePrice: number): number {\n    if (!salePrice || salePrice >= originalPrice) return 0;\n    return Math.round(((originalPrice - salePrice) / originalPrice) * 100);\n  }\n\n  /**\n   * Checks if plan has a promotion\n   */\n  hasPromotion(plan: Plan): boolean {\n    return plan.bitPromotion || (plan.decSalePrice && plan.decSalePrice < plan.decPrice);\n  }\n\n  /**\n   * Gets the effective price (sale price if available, otherwise regular price)\n   */\n  getEffectivePrice(plan: Plan): number {\n    if (plan.decSalePrice && plan.decSalePrice < plan.decPrice) {\n      return plan.decSalePrice;\n    }\n    return plan.decPrice;\n  }\n\n  /**\n   * Sorts plans by price (ascending)\n   */\n  sortByPrice(plans: Plan[], ascending: boolean = true): Plan[] {\n    return [...plans].sort((a, b) => {\n      const priceA = this.getEffectivePrice(a);\n      const priceB = this.getEffectivePrice(b);\n      return ascending ? priceA - priceB : priceB - priceA;\n    });\n  }\n}\n\n// ------------------------------------------\n// SINGLETON EXPORT\n// ------------------------------------------\n\nexport const plansService = new PlansService();\nexport default plansService;\n"]}