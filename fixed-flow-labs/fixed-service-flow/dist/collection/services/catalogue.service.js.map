{"version":3,"file":"catalogue.service.js","sourceRoot":"","sources":["../../src/services/catalogue.service.ts"],"names":[],"mappings":"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","sourcesContent":["// ============================================\n// CATALOGUE SERVICE - Product Catalogue for CLARO HOGAR\n// Fixed Service Flow Web Component\n// ============================================\n\nimport { httpService } from './http.service';\nimport { tokenService } from './token.service';\nimport { CatalogueResponse, CatalogueProduct, CatalogueFilter } from '../store/interfaces';\n\n// ------------------------------------------\n// INTERFACES\n// ------------------------------------------\n\ninterface ListCatalogueRequest {\n  catalogId: number;\n  pageNo: number;\n  pageItems: number;\n  creditClass: string;\n  orderBy: number;\n  news: number;\n  offers: string;\n  categoryID: string;\n  brand: string;\n  filter: string;\n  price: string;\n  labels: string[];\n}\n\n// API Response structure (matches TEL)\ninterface CatalogueApiResponse {\n  hasError: boolean;\n  message?: string;\n  errorDisplay?: string;\n  catalogs?: CatalogItem[];\n}\n\ninterface CatalogItem {\n  catalogId: number;\n  catalogName?: string;\n  catalog?: SubCatalogItem[];\n  products?: CatalogueProduct[];\n  brands?: any[];\n}\n\ninterface SubCatalogItem {\n  catalogId: number;\n  catalogName?: string;\n  products?: CatalogueProduct[];\n  brands?: any[];\n}\n\n// ------------------------------------------\n// CATALOGUE SERVICE CLASS\n// ------------------------------------------\n\nclass CatalogueService {\n  // Catalog IDs (from TEL API structure)\n  // catalogId 6 = Hogar (parent category)\n  // Subcategory 39 = Internet + Telefonía\n  // Subcategory 23 = Internet Inalámbrico\n  private readonly HOGAR_CATALOGUE_ID = 6;\n  private readonly DEFAULT_PAGE_ITEMS = 300;\n\n  // Filter values for selecting subcategory (used in our component)\n  // These are subcatalog IDs as strings for the filter component\n  readonly FILTER_INTERNET_TELEFONIA = '39';  // Subcatalog ID\n  readonly FILTER_INTERNET_INALAMBRICO = '23'; // Subcatalog ID\n\n  // ------------------------------------------\n  // LIST CATALOGUE\n  // ------------------------------------------\n\n  /**\n   * Fetches product catalogue for CLARO HOGAR (wireless internet devices)\n   * Endpoint: POST api/Catalogue/listCatalogue\n   *\n   * Response structure from API:\n   * {\n   *   hasError: false,\n   *   catalogs: [\n   *     { catalogId: 23, catalog: [{ catalogId: 1, products: [...] }, ...] }\n   *   ]\n   * }\n   */\n  async listCatalogue(\n    subcatalogId: string = this.FILTER_INTERNET_INALAMBRICO,\n    pageNo: number = 1,\n    searchText: string = '',\n    brand: string = '',\n    price: string = ''\n  ): Promise<CatalogueResponse> {\n    // Ensure token exists before making the call\n    await tokenService.ensureToken();\n\n    // Use parent catalog ID (Hogar = 6) and categoryID = \"0\" to get all subcategories\n    const request: ListCatalogueRequest = {\n      catalogId: this.HOGAR_CATALOGUE_ID, // Use Hogar (6) as parent\n      pageNo: pageNo,\n      pageItems: this.DEFAULT_PAGE_ITEMS,\n      creditClass: 'C',\n      orderBy: 7,\n      news: 0,\n      offers: '0',\n      categoryID: '0', // Get all subcategories\n      brand: brand,\n      filter: searchText,\n      price: price,\n      labels: [],\n    };\n\n    console.log('[CatalogueService] Request:', JSON.stringify(request));\n\n    const apiResponse = await httpService.post<CatalogueApiResponse>('api/Catalogue/listCatalogue', request);\n\n    console.log('[CatalogueService] API Response keys:', Object.keys(apiResponse || {}));\n\n    if (apiResponse.hasError) {\n      throw new Error(apiResponse.message || 'Failed to fetch catalogue');\n    }\n\n    // Parse products from the nested structure\n    // First find Hogar catalog, then find the requested subcatalog\n    const targetSubcatalogId = parseInt(subcatalogId, 10);\n    const products = this.extractProductsFromSubcatalog(apiResponse, this.HOGAR_CATALOGUE_ID, targetSubcatalogId);\n\n    console.log('[CatalogueService] Extracted products:', products.length);\n\n    return {\n      hasError: false,\n      products: products,\n      totalItems: products.length,\n    };\n  }\n\n  /**\n   * Extracts products from a specific subcatalog within the Hogar catalog\n   * Structure: catalogs[] -> find Hogar (6) -> catalog[] -> find subcatalog (23 or 39) -> products\n   */\n  private extractProductsFromSubcatalog(\n    response: CatalogueApiResponse,\n    parentCatalogId: number,\n    subcatalogId: number\n  ): CatalogueProduct[] {\n    if (!response.catalogs || !Array.isArray(response.catalogs)) {\n      console.log('[CatalogueService] No catalogs in response');\n      return [];\n    }\n\n    // Find the parent catalog (Hogar = 6)\n    const parentCatalog = response.catalogs.find(c => c.catalogId === parentCatalogId);\n\n    if (!parentCatalog) {\n      console.log('[CatalogueService] Parent catalog not found:', parentCatalogId);\n      // Try to find subcatalog directly in catalogs array\n      for (const catalog of response.catalogs) {\n        if (catalog.catalog) {\n          const subcatalog = catalog.catalog.find(sc => sc.catalogId === subcatalogId);\n          if (subcatalog) {\n            console.log('[CatalogueService] Found subcatalog in:', catalog.catalogId);\n            return subcatalog.products || [];\n          }\n        }\n      }\n      return [];\n    }\n\n    console.log('[CatalogueService] Found parent catalog:', parentCatalog.catalogId, parentCatalog.catalogName);\n\n    // Find the subcatalog within the parent\n    if (!parentCatalog.catalog || !Array.isArray(parentCatalog.catalog)) {\n      console.log('[CatalogueService] No subcatalogs in parent');\n      return parentCatalog.products || [];\n    }\n\n    const subcatalog = parentCatalog.catalog.find(sc => sc.catalogId === subcatalogId);\n\n    if (!subcatalog) {\n      console.log('[CatalogueService] Subcatalog not found:', subcatalogId);\n      console.log('[CatalogueService] Available subcatalogs:', parentCatalog.catalog.map(sc => ({ id: sc.catalogId, name: sc.catalogName })));\n      // Return first subcatalog's products as fallback\n      return parentCatalog.catalog[0]?.products || [];\n    }\n\n    console.log('[CatalogueService] Found subcatalog:', subcatalog.catalogId, subcatalog.catalogName);\n    return subcatalog.products || [];\n  }\n\n  /**\n   * BFS search for catalog by ID (matches TEL's findCatalogById)\n   * Reserved for future use with nested catalog navigation\n   */\n  // @ts-ignore: Reserved for future use\n  private _findCatalogById(catalogs: CatalogItem[], catalogId: number): CatalogItem | null {\n    const queue = [...catalogs];\n\n    while (queue.length > 0) {\n      const current = queue.shift()!;\n\n      if (current.catalogId === catalogId) {\n        return current;\n      }\n\n      if (current.catalog && current.catalog.length > 0) {\n        queue.push(...(current.catalog as CatalogItem[]));\n      }\n    }\n\n    return null;\n  }\n\n  // ------------------------------------------\n  // GET FILTERS\n  // ------------------------------------------\n\n  /**\n   * Returns the available product type filters\n   */\n  getProductTypeFilters(): CatalogueFilter[] {\n    return [\n      {\n        value: this.FILTER_INTERNET_TELEFONIA,\n        label: 'Internet + Telefonía',\n      },\n      {\n        value: this.FILTER_INTERNET_INALAMBRICO,\n        label: 'Internet Inalámbrico',\n      },\n    ];\n  }\n\n  // ------------------------------------------\n  // HELPER METHODS\n  // ------------------------------------------\n\n  /**\n   * Formats price for display (monthly installment)\n   */\n  formatInstallmentPrice(price: number): string {\n    return `$${price.toFixed(2)}/mes`;\n  }\n\n  /**\n   * Formats regular price\n   */\n  formatRegularPrice(price: number): string {\n    return `$${price.toFixed(2)}`;\n  }\n\n  /**\n   * Calculates monthly installment from total price\n   */\n  calculateInstallment(totalPrice: number, installments: number): number {\n    if (installments <= 0) return totalPrice;\n    return Number((totalPrice / installments).toFixed(2));\n  }\n\n  /**\n   * Cleans HTML from product description\n   */\n  cleanDescription(html: string): string {\n    if (!html) return '';\n    // Remove HTML tags\n    return html.replace(/<[^>]*>/g, '').trim();\n  }\n\n  /**\n   * Truncates text to max length with ellipsis\n   */\n  truncateText(text: string, maxLength: number = 80): string {\n    if (!text || text.length <= maxLength) return text;\n    return text.substring(0, maxLength).trim() + '...';\n  }\n\n  /**\n   * Parses product colors from API response\n   */\n  parseColors(colors: Array<{ webColor: string }> | undefined): string[] {\n    if (!colors || !Array.isArray(colors)) return [];\n    return colors.map(c => c.webColor).filter(Boolean);\n  }\n\n  /**\n   * Stores selected product in sessionStorage\n   */\n  storeProductInSession(product: CatalogueProduct): void {\n    try {\n      sessionStorage.setItem('selectedProduct', JSON.stringify(product));\n      sessionStorage.setItem('productId', String(product.productId));\n    } catch (e) {\n      console.error('[CatalogueService] Error storing product in session:', e);\n    }\n  }\n\n  /**\n   * Gets stored product from sessionStorage\n   */\n  getStoredProduct(): CatalogueProduct | null {\n    try {\n      const data = sessionStorage.getItem('selectedProduct');\n      return data ? JSON.parse(data) : null;\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Clears product from session\n   */\n  clearProduct(): void {\n    sessionStorage.removeItem('selectedProduct');\n    sessionStorage.removeItem('productId');\n  }\n}\n\n// ------------------------------------------\n// SINGLETON EXPORT\n// ------------------------------------------\n\nexport const catalogueService = new CatalogueService();\nexport default catalogueService;\n"]}