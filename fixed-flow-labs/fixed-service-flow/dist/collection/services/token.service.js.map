{"version":3,"file":"token.service.js","sourceRoot":"","sources":["../../src/services/token.service.ts"],"names":[],"mappings":"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","sourcesContent":["// ============================================\n// TOKEN SERVICE - Authentication Token Management\n// Fixed Service Flow Web Component\n// ============================================\n// CRITICAL: This service MUST be called before any other API calls\n// The token is required for all API operations and also serves as the cart token\n\nimport { httpService } from './http.service';\nimport { flowActions } from '../store/flow.store';\nimport { TokenResponse } from '../store/interfaces';\n\n// ------------------------------------------\n// TOKEN SERVICE CLASS\n// ------------------------------------------\n\nclass TokenService {\n  private isInitializing: boolean = false;\n  private initPromise: Promise<boolean> | null = null;\n\n  // ------------------------------------------\n  // GET TOKEN FROM API\n  // ------------------------------------------\n\n  /**\n   * Fetches a new token from the API\n   * Endpoint: POST api/Token/getToken\n   * Request: { \"agentName\": \"\" }\n   */\n  async fetchToken(): Promise<TokenResponse> {\n    const response = await httpService.post<TokenResponse>('api/Token/getToken', {\n      agentName: '',\n    });\n\n    if (response.hasError) {\n      throw new Error(response.message || 'Failed to obtain token');\n    }\n\n    return response;\n  }\n\n  // ------------------------------------------\n  // INITIALIZE TOKEN\n  // ------------------------------------------\n\n  /**\n   * Initializes the token - checks sessionStorage first, then fetches if needed\n   * This method should be called at the start of the flow\n   */\n  async initialize(): Promise<boolean> {\n    // If already initializing, return the existing promise\n    if (this.isInitializing && this.initPromise) {\n      return this.initPromise;\n    }\n\n    this.isInitializing = true;\n\n    this.initPromise = (async () => {\n      try {\n        // Check if token exists in sessionStorage\n        const stored = flowActions.getStoredToken();\n\n        if (stored.token && stored.correlationId) {\n          // Use existing token\n          flowActions.setToken(stored.token, stored.correlationId);\n          console.log('[TokenService] Using existing token from sessionStorage');\n          return true;\n        }\n\n        // Fetch new token\n        console.log('[TokenService] Fetching new token...');\n        const response = await this.fetchToken();\n\n        // Store token\n        flowActions.setToken(response.token, response.correlationId);\n        console.log('[TokenService] Token obtained and stored successfully');\n\n        return true;\n      } catch (error) {\n        console.error('[TokenService] Failed to initialize token:', error);\n        flowActions.setError('Error al obtener el token de autenticaci√≥n');\n        return false;\n      } finally {\n        this.isInitializing = false;\n      }\n    })();\n\n    return this.initPromise;\n  }\n\n  // ------------------------------------------\n  // HELPER METHODS\n  // ------------------------------------------\n\n  /**\n   * Checks if a valid token exists\n   */\n  hasToken(): boolean {\n    return flowActions.hasToken();\n  }\n\n  /**\n   * Gets the current token\n   */\n  getToken(): string | null {\n    const stored = flowActions.getStoredToken();\n    return stored.token;\n  }\n\n  /**\n   * Gets the current correlation ID\n   */\n  getCorrelationId(): string | null {\n    const stored = flowActions.getStoredToken();\n    return stored.correlationId;\n  }\n\n  /**\n   * Clears the token (logout)\n   */\n  clearToken(): void {\n    flowActions.clearToken();\n    console.log('[TokenService] Token cleared');\n  }\n\n  /**\n   * Forces a new token fetch (refresh)\n   */\n  async refreshToken(): Promise<boolean> {\n    this.clearToken();\n    return this.initialize();\n  }\n\n  // ------------------------------------------\n  // GUARD METHOD\n  // ------------------------------------------\n\n  /**\n   * Ensures a token exists before proceeding\n   * Use this as a guard before API calls\n   */\n  async ensureToken(): Promise<void> {\n    if (!this.hasToken()) {\n      const success = await this.initialize();\n      if (!success) {\n        throw new Error('Failed to obtain authentication token');\n      }\n    }\n  }\n}\n\n// ------------------------------------------\n// SINGLETON EXPORT\n// ------------------------------------------\n\nexport const tokenService = new TokenService();\nexport default tokenService;\n"]}